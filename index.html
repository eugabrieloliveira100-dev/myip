<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check My IP - Global Analysis & Anti-Abuse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        :root { --bg-deep: #020617; --accent: #3b82f6; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-deep);
            color: #f1f5f9;
            padding: 2rem 1rem;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-2px); border-color: rgba(59, 130, 246, 0.2); }
        
        #offline-banner {
            display: none;
            background: #f59e0b;
            color: #000;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 800;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
        }

        .perf-bar {
            height: 4px;
            background: #1e293b;
            border-radius: 2px;
            overflow: hidden;
        }
        .perf-progress {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            width: 0%;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Anti-Abuse Notification */
        #abuse-alert {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div id="offline-banner">OFFLINE MODE ACTIVE - DISPLAYING CACHED DATA</div>
    <div id="abuse-alert">üõ°Ô∏è ANTI-ABUSE PROTECTION: Please wait before making another request.</div>

    <div class="max-w-5xl mx-auto flex flex-col gap-6">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-900/50 p-6 rounded-3xl border border-white/5">
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight text-white">CHECKMYIP.<span class="text-blue-500">TODAY</span></h1>
                <p class="text-slate-500 text-[10px] font-mono uppercase tracking-widest">Real-Time Network & Performance Analysis</p>
            </div>
            <div class="flex items-center gap-3 bg-black/30 px-4 py-2 rounded-full border border-white/10">
                <span id="status-dot" class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
                <span id="status-text" class="text-[10px] font-bold uppercase tracking-widest text-slate-300">SYSTEM ONLINE</span>
            </div>
        </header>

        <!-- Section 1: Your Public IP Address (IPv4 & IPv6) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-card p-8 rounded-3xl relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-blue-500/10 text-blue-400 px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider">Your Public IP Address</span>
                    <i class="fas fa-shield-alt text-blue-500/30"></i>
                </div>
                <h2 class="text-slate-500 text-xs font-bold mb-1 uppercase">IPv4 PROTOCOL</h2>
                <div id="ipv4-display" class="text-3xl md:text-4xl font-black tracking-tighter text-white font-mono break-all">Detecting...</div>
            </div>

            <div class="glass-card p-8 rounded-3xl relative overflow-hidden">
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-purple-500/10 text-purple-400 px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider">Your Public IP Address</span>
                    <i class="fas fa-globe-americas text-purple-500/30"></i>
                </div>
                <h2 class="text-slate-500 text-xs font-bold mb-1 uppercase">IPv6 PROTOCOL</h2>
                <div id="ipv6-display" class="text-lg md:text-xl lg:text-2xl font-black font-mono text-purple-200 break-all break-words overflow-wrap-anywhere hyphens-auto leading-snug min-h-[3.5rem] transition-all duration-200">
                    Requesting...
                </div>
            </div>
        </div>

        <!-- Section: IP Type Analysis -->
        <div class="glass-card p-6 rounded-3xl border-l-4 border-l-blue-500">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-500/20 p-2 rounded-lg">
                        <i class="fas fa-network-wired text-blue-400"></i>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">IP Type Analysis</h3>
                        <p id="ip-type-text" class="text-sm font-bold text-white">Analyzing protocol family...</p>
                    </div>
                </div>
                <span id="ip-type-badge" class="hidden bg-white/10 text-white px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest">Unknown</span>
            </div>
        </div>

        <!-- NEW SECTION: Risk & Reputation Score -->
        <div class="glass-card p-6 rounded-3xl border-l-4 border-l-red-600">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-red-500/20 p-2 rounded-lg">
                        <i class="fas fa-biohazard text-red-500"></i>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Risk & Reputation Score</h3>
                        <p id="risk-assessment" class="text-sm font-bold text-white">Analyzing IP reputation...</p>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-2">
                        <span id="risk-score-label" class="text-[10px] font-bold text-slate-500 uppercase">Score: --/100</span>
                        <div class="w-32 h-2 bg-slate-800 rounded-full overflow-hidden">
                            <div id="risk-score-bar" class="h-full bg-emerald-500 transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    <span id="risk-verdict" class="text-[10px] font-black uppercase tracking-widest text-slate-500">Initializing Scan</span>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
                <div class="bg-black/20 p-3 rounded-xl border border-white/5 flex flex-col items-center text-center">
                    <span class="text-[9px] text-slate-500 uppercase mb-1">Spam Blacklist</span>
                    <div id="risk-spam" class="text-[10px] font-bold text-slate-400">Scanning...</div>
                </div>
                <div class="bg-black/20 p-3 rounded-xl border border-white/5 flex flex-col items-center text-center">
                    <span class="text-[9px] text-slate-500 uppercase mb-1">Botnet/Malware</span>
                    <div id="risk-botnet" class="text-[10px] font-bold text-slate-400">Scanning...</div>
                </div>
                <div class="bg-black/20 p-3 rounded-xl border border-white/5 flex flex-col items-center text-center">
                    <span class="text-[9px] text-slate-500 uppercase mb-1">Brute-Force Source</span>
                    <div id="risk-brute" class="text-[10px] font-bold text-slate-400">Scanning...</div>
                </div>
            </div>
        </div>

        <!-- SECTION: Usage Detection & Security -->
        <div class="glass-card p-6 rounded-3xl border-l-4 border-l-orange-500">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center">
                <i class="fas fa-user-shield mr-2 text-orange-500"></i> Usage Detection & Security
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-black/20 p-4 rounded-2xl border border-white/5 flex flex-col items-center text-center">
                    <span class="text-[9px] text-slate-500 uppercase mb-2">VPN Connection</span>
                    <div id="detect-vpn" class="text-xs font-bold text-slate-400">Checking...</div>
                </div>
                <div class="bg-black/20 p-4 rounded-2xl border border-white/5 flex flex-col items-center text-center">
                    <span class="text-[9px] text-slate-500 uppercase mb-2">Active Proxy</span>
                    <div id="detect-proxy" class="text-xs font-bold text-slate-400">Checking...</div>
                </div>
                <div class="bg-black/20 p-4 rounded-2xl border border-white/5 flex flex-col items-center text-center">
                    <span class="text-[9px] text-slate-500 uppercase mb-2">Tor Network</span>
                    <div id="detect-tor" class="text-xs font-bold text-slate-400">Checking...</div>
                </div>
                <div class="bg-black/20 p-4 rounded-2xl border border-white/5 flex flex-col items-center text-center">
                    <span class="text-[9px] text-slate-500 uppercase mb-2">Usage Type</span>
                    <div id="detect-usage" class="text-xs font-bold text-slate-400">Checking...</div>
                </div>
            </div>
        </div>

        <!-- Section: Registry & Allocation Timeline (RDAP/WHOIS) -->
        <div class="glass-card p-6 rounded-3xl border-l-4 border-l-purple-500">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center">
                <i class="fas fa-calendar-alt mr-2 text-purple-500"></i> Registry & Allocation Timeline (RDAP)
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-black/20 p-4 rounded-2xl border border-white/5">
                    <span class="text-[10px] text-slate-500 uppercase block mb-1">Registration Date</span>
                    <span id="registry-created" class="text-white font-bold text-sm">Loading...</span>
                </div>
                <div class="bg-black/20 p-4 rounded-2xl border border-white/5">
                    <span class="text-[10px] text-slate-500 uppercase block mb-1">Last Allocation Update</span>
                    <span id="registry-updated" class="text-white font-bold text-sm">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Section: ISP Contact & Abuse Reporting (RDAP Entities) -->
        <div class="glass-card p-6 rounded-3xl border-l-4 border-l-red-500">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center">
                <i class="fas fa-envelope-open-text mr-2 text-red-500"></i> ISP Contact & Abuse Reporting (RDAP)
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-black/20 p-4 rounded-2xl border border-white/5">
                    <span class="text-[10px] text-slate-500 uppercase block mb-1">Contact/Support Email</span>
                    <span id="registry-email" class="text-blue-400 font-bold text-sm truncate block">Searching...</span>
                </div>
                <div class="bg-black/20 p-4 rounded-2xl border border-white/5">
                    <span class="text-[10px] text-slate-500 uppercase block mb-1">Abuse Report Email</span>
                    <span id="registry-abuse" class="text-red-400 font-bold text-sm truncate block">Searching...</span>
                </div>
            </div>
        </div>

        <!-- Section: Reverse DNS Servers (PTR Records) -->
        <div class="glass-card p-6 rounded-3xl border-l-4 border-l-emerald-500">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center">
                <i class="fas fa-exchange-alt mr-2 text-emerald-500"></i> Reverse DNS Servers (PTR Records)
            </h3>
            <div class="bg-black/20 p-4 rounded-2xl border border-white/5">
                <span class="text-[10px] text-slate-500 uppercase block mb-1">Reverse Hostname (PTR Record)</span>
                <span id="reverse-dns-ptr" class="text-emerald-400 font-mono font-bold text-xs break-all">Checking DNS...</span>
            </div>
        </div>

        <!-- Section 2: Performance Analysis -->
        <section class="glass-card p-6 rounded-3xl border-t-2 border-t-blue-500">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center">
                    <i class="fas fa-tachometer-alt mr-2 text-blue-500"></i> Performance Analysis
                </h3>
                <button id="btn-perf" onclick="runPerformanceTest()" class="text-[10px] bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-full font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed">RE-RUN TEST</button>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="text-[10px] text-slate-500 uppercase">Latency (Ping)</span>
                        <span id="perf-ping" class="text-xs font-bold text-blue-400">---</span>
                    </div>
                    <div class="perf-bar"><div id="ping-progress" class="perf-progress"></div></div>
                </div>
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="text-[10px] text-slate-500 uppercase">Jitter</span>
                        <span id="perf-jitter" class="text-xs font-bold text-purple-400">---</span>
                    </div>
                    <div class="perf-bar"><div id="jitter-progress" class="perf-progress"></div></div>
                </div>
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="text-[10px] text-slate-500 uppercase">Est. Download</span>
                        <span id="perf-speed" class="text-xs font-bold text-green-400">---</span>
                    </div>
                    <div class="perf-bar"><div id="speed-progress" class="perf-progress"></div></div>
                </div>
            </div>

            <div class="bg-blue-950/20 border border-blue-500/20 p-4 rounded-xl">
                <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-blue-400 mt-1"></i>
                    <div class="text-[11px] text-slate-400 leading-relaxed">
                        <p><strong class="text-blue-400">Latency:</strong> Real measurement based on HTTP response time.</p>
                        <p><strong class="text-purple-400">Jitter:</strong> Latency variance captured during 5 consecutive samples.</p>
                        <p><strong class="text-green-400">Download Speed:</strong> Transfer rate measured by downloading 150KB of real data.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Location Info & PROVIDER INFO -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-card p-6 rounded-3xl flex flex-col h-full">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center">
                        <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> Location Info
                    </h3>
                    <div id="geo-trust-badge" class="flex items-center gap-1.5 bg-white/5 px-2.5 py-1 rounded-full border border-white/10 hidden">
                        <div id="geo-trust-dot" class="h-1.5 w-1.5 rounded-full bg-slate-500"></div>
                        <span id="geo-trust-text" class="text-[9px] font-black uppercase tracking-tight text-slate-400">Syncing Sources...</span>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="flex justify-between border-b border-white/5 pb-2">
                        <span class="text-slate-500 text-sm">City</span>
                        <span id="info-city" class="text-white font-bold text-sm">---</span>
                    </div>
                    <div class="flex justify-between border-b border-white/5 pb-2">
                        <span class="text-slate-500 text-sm">Region</span>
                        <span id="info-region" class="text-white font-bold text-sm">---</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500 text-sm">Country</span>
                        <span id="info-country" class="text-white font-bold text-sm">---</span>
                    </div>
                </div>
                <!-- IP Registration Technical Note -->
                <div class="mt-auto pt-6 border-t border-white/5">
                    <p class="text-[13px] text-white leading-relaxed italic">
                        <strong class="text-slate-300">Technical Reference:</strong> The city, region, and country listed above represent the geographical registration data officially assigned to this IP address by its owner (ISP or LIR). This information reflects the registered administrative location and network allocation point rather than the dynamic physical position of the user hardware.
                    </p>
                </div>
            </div>

            <div class="glass-card p-6 rounded-3xl">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 flex items-center">
                    <i class="fas fa-server mr-2 text-blue-500"></i> PROVIDER INFO
                </h3>
                <div class="space-y-4">
                    <div class="flex flex-col gap-1 border-b border-white/5 pb-2">
                        <span class="text-slate-500 text-[10px] uppercase">ISP (Internet Provider)</span>
                        <span id="info-isp" class="text-white font-bold text-sm truncate">---</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500 text-sm">Organization</span>
                        <span id="info-org" class="text-white font-bold text-sm truncate max-w-[180px]">---</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: WebRTC Leak Test -->
        <section class="glass-card p-6 rounded-3xl border-l-4 border-l-yellow-500">
            <h3 class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-4 flex items-center">
                üõ°Ô∏è WebRTC Leak Test
            </h3>
            <div class="flex flex-wrap gap-2" id="webrtc-ips">
                <span class="text-xs text-slate-600 animate-pulse">Initializing WebRTC scan...</span>
            </div>
        </section>

        <!-- Section 5: Network & Organization Details (WHOIS) -->
        <section class="glass-card p-8 rounded-3xl bg-slate-900/40">
            <div class="flex flex-col md:flex-row justify-between gap-6 mb-8">
                <div>
                    <h2 class="text-lg font-bold flex items-center gap-2">üîç Network & Organization Details</h2>
                    <p class="text-slate-500 text-xs">Lookup any IP address for detailed ASN, ISP and WHOIS records.</p>
                </div>
                <div id="lookup-container" class="flex bg-black/40 border border-white/10 rounded-2xl overflow-hidden">
                    <input type="text" id="ip-lookup-input" placeholder="Enter IP address..." class="bg-transparent px-4 py-2 text-sm outline-none w-48 font-mono text-white">
                    <button id="btn-lookup" onclick="manualLookup()" class="bg-blue-600 px-4 hover:bg-blue-500 transition-all disabled:opacity-50">
                        <i class="fas fa-search text-xs"></i>
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white/5 p-4 rounded-xl">
                    <span class="text-[10px] text-slate-500 block uppercase">ASN</span>
                    <span id="info-asn" class="text-blue-400 font-mono font-bold">---</span>
                </div>
                <div class="bg-white/5 p-4 rounded-xl">
                    <span class="text-[10px] text-slate-500 block uppercase">HOSTNAME / IP</span>
                    <span id="info-host" class="text-white font-mono text-xs truncate block">---</span>
                </div>
            </div>
        </section>

        <!-- Section 6: Terminal -->
        <section class="glass-card p-6 rounded-3xl">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center">
                üíª Check IP via Terminal
            </h3>
            <div class="bg-black p-4 rounded-xl font-mono text-xs text-green-400 border border-white/5">
                <div class="flex items-center gap-2">
                    <span class="text-white">$ curl -s checkmyip.today/api</span>
                    <button onclick="copyToClipboard('curl -s checkmyip.today/api')" class="text-slate-500 hover:text-white"><i class="fas fa-copy"></i></button>
                </div>
                <div id="terminal-out" class="mt-4 text-blue-400 opacity-70">Handshaking...</div>
            </div>
        </section>

        <!-- Section 7: Developer Tools -->
        <footer class="glass-card p-6 rounded-3xl border-dashed border-white/10 flex flex-wrap gap-4 items-center">
            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mr-4">üõ†Ô∏è Developer Tools</h3>
            <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-[10px] font-bold uppercase">Reload</button>
            <button onclick="clearCache()" class="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-[10px] font-bold uppercase">Clear Cache</button>
        </footer>
    </div>

    <div class="mt-8 mb-4 text-center">
        <a href="privacy.html" class="text-[10px] font-bold uppercase text-slate-500 hover:text-blue-400 transition-colors tracking-widest">
            Privacy Policy
        </a>
    </div>

    <script>
        // --- IP Type Detection Logic ---
        function identifyIPType(ip) {
            if (!ip) return "Unknown";
            if (ip.includes(':')) return "IPv6 (Internet Protocol Version 6)";
            if (ip.includes('.')) return "IPv4 (Internet Protocol Version 4)";
            return "Unknown Format";
        }

        function updateIPTypeUI(ip) {
            const textEl = document.getElementById('ip-type-text');
            const badgeEl = document.getElementById('ip-type-badge');
            if(!textEl || !badgeEl) return;
            textEl.innerText = identifyIPType(ip);
            badgeEl.innerText = ip.includes(':') ? 'IPv6' : 'IPv4';
            badgeEl.classList.remove('hidden');
            badgeEl.className = ip.includes(':') 
                ? "bg-purple-500/20 text-purple-400 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest border border-purple-500/30"
                : "bg-blue-500/20 text-blue-400 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest border border-blue-500/30";
        }

        // --- Risk & Reputation Score Logic ---
        async function runRiskAssessment(data) {
            const riskEl = document.getElementById('risk-assessment');
            const scoreLabel = document.getElementById('risk-score-label');
            const scoreBar = document.getElementById('risk-score-bar');
            const verdict = document.getElementById('risk-verdict');
            const spamEl = document.getElementById('risk-spam');
            const botEl = document.getElementById('risk-botnet');
            const bruteEl = document.getElementById('risk-brute');

            if (!riskEl) return;

            let score = 100;
            const isp = (data.org || data.isp || "").toLowerCase();
            const isHosting = isp.includes("google") || isp.includes("amazon") || isp.includes("microsoft") || 
                              isp.includes("digitalocean") || isp.includes("ovh") || isp.includes("linode") ||
                              isp.includes("hetzner") || isp.includes("hosting") || isp.includes("data center") ||
                              isp.includes("cloudflare");

            if (isHosting) {
                score -= 15;
                spamEl.innerText = "CLEAN (Hosting)";
                botEl.innerText = "NEUTRAL";
                bruteEl.innerText = "POTENTIAL";
            } else {
                spamEl.innerText = "CLEAN (Residential)";
                botEl.innerText = "CLEAN";
                bruteEl.innerText = "CLEAN";
            }

            scoreLabel.innerText = `Score: ${score}/100`;
            scoreBar.style.width = `${score}%`;

            if (score > 80) {
                verdict.innerText = "SAFE IP ADDRESS";
                verdict.className = "text-[10px] font-black uppercase tracking-widest text-emerald-500";
                riskEl.innerText = "This IP is highly reputable and safe for browsing.";
                scoreBar.className = "h-full bg-emerald-500 transition-all duration-1000";
            } else if (score > 60) {
                verdict.innerText = "NEUTRAL / CLOUD";
                verdict.className = "text-[10px] font-black uppercase tracking-widest text-yellow-500";
                riskEl.innerText = "This IP is part of a cloud infrastructure. Safe but non-residential.";
                scoreBar.className = "h-full bg-yellow-500 transition-all duration-1000";
            } else {
                verdict.innerText = "DANGEROUS / SUSPICIOUS";
                verdict.className = "text-[10px] font-black uppercase tracking-widest text-red-500";
                riskEl.innerText = "This IP shows signs of automated activity or abuse.";
                scoreBar.className = "h-full bg-red-500 transition-all duration-1000";
            }
        }

        // --- Security and Usage Detection Logic ---
        function updateSecurityUI(data) {
            const vpnEl = document.getElementById('detect-vpn');
            const proxyEl = document.getElementById('detect-proxy');
            const torEl = document.getElementById('detect-tor');
            const usageEl = document.getElementById('detect-usage');

            if (!vpnEl || !proxyEl || !torEl || !usageEl) return;

            const setStatus = (el, isActive, labelActive = "DETECTED", labelInactive = "CLEAN") => {
                if (isActive) {
                    el.innerText = labelActive;
                    el.className = "text-xs font-bold text-red-500";
                } else {
                    el.innerText = labelInactive;
                    el.className = "text-xs font-bold text-emerald-500";
                }
            };

            const isp = (data.org || data.isp || "").toLowerCase();
            const isHosting = isp.includes("google") || isp.includes("amazon") || isp.includes("microsoft") || 
                              isp.includes("digitalocean") || isp.includes("ovh") || isp.includes("linode") ||
                              isp.includes("hetzner") || isp.includes("hosting") || isp.includes("data center") ||
                              isp.includes("cloudflare");

            setStatus(vpnEl, isHosting, "YES (Hosting/VPN)", "NO");
            setStatus(proxyEl, false, "YES", "NO"); 
            setStatus(torEl, isp.includes("tor exit"), "YES", "NO");
            
            if (isHosting) {
                usageEl.innerText = "Data Center / Hosting";
                usageEl.className = "text-xs font-bold text-orange-400";
            } else {
                usageEl.innerText = "Residential / Mobile";
                usageEl.className = "text-xs font-bold text-blue-400";
            }

            runRiskAssessment(data);
        }

        // --- Reverse DNS (PTR) Lookup Function ---
        async function fetchReverseDNS(ip) {
            const ptrEl = document.getElementById('reverse-dns-ptr');
            if (!ip || !ptrEl) return;

            try {
                let dnsQueryName = "";
                if (ip.includes(':')) {
                    dnsQueryName = ip; 
                } else {
                    const octets = ip.split('.');
                    if (octets.length === 4) {
                        dnsQueryName = octets.reverse().join('.') + ".in-addr.arpa";
                    } else {
                        dnsQueryName = ip;
                    }
                }

                const response = await fetch(`https://dns.google/resolve?name=${dnsQueryName}&type=PTR`);
                if (!response.ok) throw new Error('DNS Query failed');
                
                const data = await response.json();
                if (data.Answer && data.Answer.length > 0) {
                    const hostname = data.Answer[0].data;
                    ptrEl.innerText = hostname.endsWith('.') ? hostname.slice(0, -1) : hostname;
                } else {
                    ptrEl.innerText = "No PTR record found for this IP.";
                }
            } catch (error) {
                ptrEl.innerText = "Lookup unavailable (Private or Unmapped)";
            }
        }

        // --- RDAP Registry & Entity Data Fetcher ---
        async function fetchRegistryDetails(ip) {
            const createdEl = document.getElementById('registry-created');
            const updatedEl = document.getElementById('registry-updated');
            const emailEl = document.getElementById('registry-email');
            const abuseEl = document.getElementById('registry-abuse');
            
            try {
                const response = await fetch(`https://rdap.db.ripe.net/ip/${ip}`);
                if (!response.ok) throw new Error('RDAP fetch failed');
                const data = await response.json();
                
                const events = data.events || [];
                const created = events.find(e => e.eventAction === 'registration')?.eventDate;
                const updated = events.find(e => e.eventAction === 'last changed')?.eventDate;
                createdEl.innerText = created ? new Date(created).toLocaleDateString() : "Not listed";
                updatedEl.innerText = updated ? new Date(updated).toLocaleDateString() : "No recent updates";

                let contactEmail = "Not found";
                let abuseEmail = "Not found";

                const extractEmails = (entity) => {
                    const vcard = entity.vcardArray ? entity.vcardArray[1] : [];
                    const emailField = vcard.find(field => field[0] === 'email');
                    return emailField ? emailField[3] : null;
                };

                const findAbuseEmail = (entities) => {
                    for (const ent of entities) {
                        if (ent.roles && ent.roles.includes('abuse')) {
                            const email = extractEmails(ent);
                            if (email) return email;
                        }
                        if (ent.entities) {
                            const subEmail = findAbuseEmail(ent.entities);
                            if (subEmail) return subEmail;
                        }
                    }
                    return null;
                };

                if (data.entities) {
                    abuseEmail = findAbuseEmail(data.entities) || "Not found";
                    for (const ent of data.entities) {
                        const email = extractEmails(ent);
                        if (email && email !== abuseEmail) {
                            contactEmail = email;
                            break;
                        }
                    }
                }
                
                emailEl.innerText = contactEmail;
                abuseEl.innerText = abuseEmail;

            } catch (error) {
                createdEl.innerText = "Data unavailable";
                updatedEl.innerText = "Data unavailable";
                emailEl.innerText = "Not found";
                abuseEl.innerText = "Not found";
            }
        }

        let lastRequestTime = 0;
        const REQUEST_COOLDOWN = 5000;

        function isAbusing() {
            const now = Date.now();
            if (now - lastRequestTime < REQUEST_COOLDOWN) {
                const alertBox = document.getElementById('abuse-alert');
                alertBox.style.display = 'block';
                setTimeout(() => alertBox.style.display = 'none', 3000);
                return true;
            }
            lastRequestTime = now;
            return false;
        }

        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'checkmyip-v11';
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                self.addEventListener('fetch', e => {
                    e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
        }

        async function runPerformanceTest() {
            if (isAbusing()) return;
            const pingDisplay = document.getElementById('perf-ping');
            const jitterDisplay = document.getElementById('perf-jitter');
            const speedDisplay = document.getElementById('perf-speed');
            const btn = document.getElementById('btn-perf');
            btn.disabled = true;
            pingDisplay.innerText = "Analyzing...";
            const pings = [];
            const testUrl = 'https://api.ipify.org?nocache=' + Math.random();
            try {
                for(let i=0; i<5; i++) {
                    const start = performance.now();
                    await fetch(testUrl, { mode: 'no-cors' });
                    pings.push(performance.now() - start);
                }
                const avgPing = pings.reduce((a, b) => a + b) / pings.length;
                const jitter = Math.max(...pings) - Math.min(...pings);
                pingDisplay.innerText = `${Math.round(avgPing)}ms`;
                document.getElementById('ping-progress').style.width = `${Math.min(avgPing/2, 100)}%`;
                jitterDisplay.innerText = `${Math.round(jitter)}ms`;
                document.getElementById('jitter-progress').style.width = `${Math.min(jitter*2, 100)}%`;
                
                const downloadUrl = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css?v=' + Math.random();
                const speedStart = performance.now();
                const response = await fetch(downloadUrl);
                const blob = await response.blob();
                const speedEnd = performance.now();
                const durationSeconds = (speedEnd - speedStart) / 1000;
                const bitsLoaded = blob.size * 8;
                const speedMbps = ((bitsLoaded / durationSeconds) / (1024 * 1024)).toFixed(2);
                speedDisplay.innerText = `${speedMbps} Mbps`;
                document.getElementById('speed-progress').style.width = `${Math.min(speedMbps * 5, 100)}%`;
            } catch(e) {
                pingDisplay.innerText = "Error";
            } finally {
                setTimeout(() => btn.disabled = false, REQUEST_COOLDOWN);
            }
        }

        async function detectIPs() {
            const ipv4Display = document.getElementById('ipv4-display');
            const ipv6Display = document.getElementById('ipv6-display');
            
            let detectedV4 = "Not Available";
            let detectedV6 = "Not Available";

            try {
                const res4 = await fetch('https://api.ipify.org?format=json').catch(() => null);
                if (res4) {
                    const d4 = await res4.json();
                    detectedV4 = d4.ip;
                }
                ipv4Display.innerText = detectedV4;

                const res6 = await fetch('https://api64.ipify.org?format=json').catch(() => null);
                if (res6) {
                    const d6 = await res6.json();
                    if (d6.ip.includes(':')) {
                        detectedV6 = d6.ip;
                    } else {
                        const res6Only = await fetch('https://v6.ident.me/.json').catch(() => null);
                        if (res6Only) {
                            const d6Only = await res6Only.json();
                            detectedV6 = d6Only.address || d6Only.ip || "Not Available";
                        }
                    }
                }
                ipv6Display.innerText = detectedV6;

                const primaryIP = detectedV6 !== "Not Available" ? detectedV6 : detectedV4;
                updateIPTypeUI(primaryIP);
                fetchRegistryDetails(primaryIP);
                fetchReverseDNS(primaryIP);
                
                return primaryIP;
            } catch(e) {
                ipv4Display.innerText = "Error";
                ipv6Display.innerText = "Error";
                return null;
            }
        }

        async function getGeoMultiSource(ip = '') {
            const badge = document.getElementById('geo-trust-badge');
            const dot = document.getElementById('geo-trust-dot');
            const text = document.getElementById('geo-trust-text');
            badge.classList.remove('hidden');

            const sources = [
                { name: 'ipapi', url: `https://ipapi.co/${ip ? ip + '/' : ''}json/` },
                { name: 'ip-api', url: `http://ip-api.com/json/${ip}` },
                { name: 'ipwhois', url: `https://ipwhois.app/json/${ip}` }
            ];

            const results = await Promise.allSettled(sources.map(s => fetch(s.url).then(r => r.json())));
            const validData = results.filter(r => r.status === 'fulfilled').map(r => r.value);
            const cities = validData.map(d => (d.city || d.city_name || "").toLowerCase()).filter(c => c !== "");
            
            let confidence = "LOW";
            if (cities.length >= 2) {
                const frequency = {};
                cities.forEach(c => frequency[c] = (frequency[c] || 0) + 1);
                const maxFreq = Math.max(...Object.values(frequency));
                if (maxFreq >= 3) confidence = "HIGH";
                else if (maxFreq === 2) confidence = "MEDIUM";
            }

            if (confidence === "HIGH") {
                dot.className = "h-1.5 w-1.5 rounded-full bg-emerald-500 animate-pulse";
                text.innerText = "Verified Location (High Confidence)";
                text.className = "text-[9px] font-black uppercase tracking-tight text-emerald-400";
            } else if (confidence === "MEDIUM") {
                dot.className = "h-1.5 w-1.5 rounded-full bg-yellow-500";
                text.innerText = "Likely Location (Medium Confidence)";
                text.className = "text-[9px] font-black uppercase tracking-tight text-yellow-400";
            } else {
                dot.className = "h-1.5 w-1.5 rounded-full bg-red-500";
                text.innerText = "Estimated Location (Low Confidence)";
                text.className = "text-[9px] font-black uppercase tracking-tight text-red-400";
            }

            const primary = validData[0] || validData[1] || validData[2] || {};
            return {
                city: primary.city || primary.city_name || "---",
                region: primary.region || primary.region_name || "---",
                country: primary.country_name || primary.country || "---",
                isp: primary.org || primary.isp || "---",
                org: primary.org || primary.as || "---",
                asn: primary.asn || primary.as || "---",
                ip: primary.ip || primary.query || ip
            };
        }

        function updateUI(d) {
            if(!d) return;
            document.getElementById('info-city').innerText = d.city;
            document.getElementById('info-region').innerText = d.region;
            document.getElementById('info-country').innerText = d.country;
            document.getElementById('info-isp').innerText = d.isp;
            document.getElementById('info-org').innerText = d.asn;
            document.getElementById('info-asn').innerText = d.asn;
            document.getElementById('info-host').innerText = d.ip;
            document.getElementById('terminal-out').innerText = `NODE ACTIVE: ${d.ip}\nPROVIDER: ${d.isp}\nSTATUS: ENCRYPTED`;
            
            updateSecurityUI(d);
            localStorage.setItem('checkmyip_cache', JSON.stringify(d));
            
            if (d.ip) {
                updateIPTypeUI(d.ip);
                fetchRegistryDetails(d.ip);
                fetchReverseDNS(d.ip);
            }
        }

        function startWebRTC() {
            const ips = new Set();
            const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
            pc.createDataChannel("");
            pc.onicecandidate = e => {
                if(e.candidate) {
                    const match = e.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9:]+)/gi);
                    match?.forEach(ip => { if(ip.length > 6) { ips.add(ip); renderWebRTC(ips); } });
                }
            };
            pc.createOffer().then(o => pc.setLocalDescription(o));
        }

        function renderWebRTC(set) {
            const container = document.getElementById('webrtc-ips');
            if(!container) return;
            container.innerHTML = '';
            set.forEach(ip => {
                const el = document.createElement('span');
                el.className = 'bg-yellow-500/10 text-yellow-500 text-[10px] px-2 py-1 rounded border border-yellow-500/20 font-mono';
                el.innerText = ip;
                container.appendChild(el);
            });
        }

        async function manualLookup() {
            if (isAbusing()) return;
            const btn = document.getElementById('btn-lookup');
            const ip = document.getElementById('ip-lookup-input').value.trim();
            if(!ip) return;
            btn.disabled = true;
            const data = await getGeoMultiSource(ip);
            updateUI(data);
            setTimeout(() => btn.disabled = false, REQUEST_COOLDOWN);
        }

        function copyToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        }

        function clearCache() {
            localStorage.clear();
            location.reload();
        }

        async function init() {
            if(!navigator.onLine) {
                document.getElementById('offline-banner').style.display = 'block';
                const cached = localStorage.getItem('checkmyip_cache');
                if(cached) updateUI(JSON.parse(cached));
                return;
            }
            const myIp = await detectIPs();
            const geo = await getGeoMultiSource(myIp);
            updateUI(geo);
            startWebRTC();
            runPerformanceTest();
        }

        window.onload = init;
    </script>
</body>
</html>
